{% extends 'base.html' %}

{% block title %}Bulk Grade Projects - Teacher Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="bi bi-check-all"></i> Bulk Grade Projects</h2>
        <p class="text-muted mb-0">Grade multiple projects at once with the same score and feedback</p>
    </div>
    <a href="{% url 'teacher_projects' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Projects
    </a>
</div>

{% if form.projects.queryset.count > 0 %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-list-check"></i> Select Projects to Grade</h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <!-- Projects Selection -->
                    <div class="mb-4">
                        <label class="form-label">
                            <strong>Select Projects</strong>
                            <span class="text-danger">*</span>
                        </label>
                        
                        <div class="mb-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="selectAll">Select All</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="selectNone">Select None</button>
                        </div>
                        
                        <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                            {% for project in form.projects %}
                                <div class="form-check mb-2">
                                    {{ project.tag }}
                                    <label class="form-check-label" for="{{ project.id_for_label }}">
                                        <div class="ms-2">
                                            <strong>{{ project.choice_label.title }}</strong>
                                            <br>
                                            <small class="text-muted">
                                                Student: {{ project.choice_label.student.first_name }} {{ project.choice_label.student.last_name }}
                                                | Submitted: {{ project.choice_label.submitted_at|date:"M d, Y" }}
                                            </small>
                                        </div>
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                        
                        {% if form.projects.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.projects.errors.0 }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Score Input -->
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.score.id_for_label }}" class="form-label">
                                <strong>Score (0-100)</strong>
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.score }}
                            <div class="form-text">{{ form.score.help_text }}</div>
                            {% if form.score.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.score.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-8 mb-3">
                            <label class="form-label">
                                <strong>Letter Grade Preview</strong>
                            </label>
                            <div class="alert alert-info" id="gradePreview">
                                <span class="h5 mb-0" id="letterGrade">-</span>
                                <small class="ms-2" id="gradeDescription">Enter a score to see letter grade</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Feedback -->
                    <div class="mb-4">
                        <label for="{{ form.feedback.id_for_label }}" class="form-label">
                            <strong>Feedback (Optional)</strong>
                        </label>
                        {{ form.feedback }}
                        <div class="form-text">This feedback will be applied to all selected projects.</div>
                        {% if form.feedback.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.feedback.errors.0 }}
                            </div>
                        {% endif %}
                    </div>
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'teacher_projects' %}" class="btn btn-secondary">
                            <i class="bi bi-x-lg"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-success" onclick="return confirm('Are you sure you want to grade all selected projects with the same score and feedback?');">
                            <i class="bi bi-check-all"></i> Grade Selected Projects
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Grading Guidelines -->
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-info-circle"></i> Grading Scale</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="border rounded p-2">
                            <strong class="text-success">A+ (90-100)</strong>
                            <br><small class="text-muted">Excellent</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="border rounded p-2">
                            <strong class="text-success">A (80-89)</strong>
                            <br><small class="text-muted">Very Good</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="border rounded p-2">
                            <strong class="text-warning">B+ (70-79)</strong>
                            <br><small class="text-muted">Good</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="border rounded p-2">
                            <strong class="text-warning">B (60-69)</strong>
                            <br><small class="text-muted">Satisfactory</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="border rounded p-2">
                            <strong class="text-info">C+ (50-59)</strong>
                            <br><small class="text-muted">Average</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="border rounded p-2">
                            <strong class="text-info">C (40-49)</strong>
                            <br><small class="text-muted">Below Average</small>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <div class="small text-muted">
                    <strong>Tips for Bulk Grading:</strong>
                    <ul class="mt-2">
                        <li>Use for similar quality submissions</li>
                        <li>Consider individual feedback later if needed</li>
                        <li>You can edit grades individually afterward</li>
                        <li>Double-check your selection before submitting</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAllBtn = document.getElementById('selectAll');
    const selectNoneBtn = document.getElementById('selectNone');
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    const scoreInput = document.getElementById('{{ form.score.id_for_label }}');
    const letterGradeElement = document.getElementById('letterGrade');
    const gradeDescriptionElement = document.getElementById('gradeDescription');
    const gradePreviewElement = document.getElementById('gradePreview');
    
    // Select All functionality
    selectAllBtn.addEventListener('click', function() {
        checkboxes.forEach(checkbox => {
            checkbox.checked = true;
        });
    });
    
    // Select None functionality
    selectNoneBtn.addEventListener('click', function() {
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
    });
    
    // Grade preview functionality
    function updateGradePreview() {
        const score = parseInt(scoreInput.value) || 0;
        let letterGrade = 'F';
        let description = '';
        let alertClass = 'alert-danger';
        
        if (score >= 90) {
            letterGrade = 'A+';
            description = 'Excellent work';
            alertClass = 'alert-success';
        } else if (score >= 80) {
            letterGrade = 'A';
            description = 'Very good work';
            alertClass = 'alert-success';
        } else if (score >= 70) {
            letterGrade = 'B+';
            description = 'Good work';
            alertClass = 'alert-warning';
        } else if (score >= 60) {
            letterGrade = 'B';
            description = 'Satisfactory work';
            alertClass = 'alert-warning';
        } else if (score >= 50) {
            letterGrade = 'C+';
            description = 'Average work';
            alertClass = 'alert-info';
        } else if (score >= 40) {
            letterGrade = 'C';
            description = 'Below average work';
            alertClass = 'alert-info';
        } else if (score >= 30) {
            letterGrade = 'D';
            description = 'Poor work';
            alertClass = 'alert-danger';
        } else {
            description = score > 0 ? 'Failing grade' : 'Enter a score to see letter grade';
        }
        
        letterGradeElement.textContent = letterGrade;
        gradeDescriptionElement.textContent = description;
        gradePreviewElement.className = `alert ${alertClass}`;
    }
    
    scoreInput.addEventListener('input', updateGradePreview);
    updateGradePreview(); // Initial call
});
</script>
{% else %}
<div class="card">
    <div class="card-body text-center py-5">
        <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
        <h4 class="mt-3 text-muted">No Projects Available for Bulk Grading</h4>
        <p class="text-muted mb-4">All submitted projects have already been graded, or there are no submitted projects yet.</p>
        <a href="{% url 'teacher_projects' %}" class="btn btn-primary">
            <i class="bi bi-eye"></i> View All Projects
        </a>
    </div>
</div>
{% endif %}
{% endblock %}
